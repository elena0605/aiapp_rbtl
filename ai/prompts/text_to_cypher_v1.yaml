id: graph.text_to_cypher
version: 1
description: Convert a user question into a Cypher statement using the provided schema, mappings and examples.
tags: [graph, cypher, retrieval]
params:
  temperature: 0.0
  max_tokens: 1200

variables:
  - name: schema
  - name: terminology
  - name: examples
  - name: question

template: |
Instructions:
Generate one Cypher statement that answers the user question.

Graph Database Schema:
Use only the provided relationship types and properties in the schema.
Do not use any relationship types or properties that are not provided.
{{schema}}

Terminology mapping:
Use terminology to map user wording to schema properties and values.
{{terminology}}

Examples:
Use examples as patterns, not strict templates.
{{examples}}

Output format:
- Output only Cypher.
- No explanation, no prose, no markdown, no code fences.

INTERNAL PLANNING WORKFLOW (DO NOT OUTPUT):
1) Identify intent type:
   - lookup, prevalence/rate, comparison, association/correlation, ranking, trend.
2) Normalize wording:
   - Treat paraphrases as equivalent:
     prevalence/rate/proportion/percentage
     associated with/related to/linked to/clustered with
     higher/lower/more/less
3) Resolve concepts:
   - First try direct property mapping.
   - If abstract concept is used, resolve via terminology.abstract_concepts.indicators.
   - If multiple concepts are used, include indicators from all relevant concepts.
4) Build query:
   - Use read-only Cypher only.
   - Compute metrics required by the intent.
5) Self-check:
   - Uses only allowed schema elements.
   - Matches question intent.
   - Safe division and valid array handling.

SECURITY RESTRICTION - READ-ONLY:
- Generate read-only queries only (MATCH/OPTIONAL MATCH/WITH/WHERE/RETURN/ORDER BY/LIMIT).
- Never use CREATE, SET, DELETE, REMOVE, MERGE, DETACH DELETE, FOREACH.
- If request requires write/modification, return empty response.

SEMANTIC CORRECTNESS:
- Query must answer the exact question.
- Do not ignore key parts of the question.
- If concept does not exist in schema/terminology, return empty response.

RETURN RULES:
- Return minimal fields needed to answer the question.
- Include fields used for filtering/comparison when needed for interpretation.
- Convert temporal outputs with toString().

AGGREGATED PERSON ARRAY RULES:
- All person_* properties are aggregated arrays.
- Never treat person_* as scalar values.
- Use exact value strings from terminology (case-sensitive).
- Prevalence pattern:
  size(array) AS total_responses
  size([x IN array WHERE x IN [value1, value2, ...]]) AS relevant_count
  ROUND(100.0 * relevant_count / total_responses, 2) AS relevant_perc
- Always protect division:
  WHERE total_responses > 0

ASSOCIATION / COMPARISON RULES:
- If question asks association/comparison/correlation or uses phrases like:
  "associated with", "more likely", "also show", "higher/lower than", "relationship between", "clustered with"
  then:
  - compute metrics for each side separately
  - return both metrics in the same row (same Area or Municipality)
  - optionally return a difference metric for easier interpretation

ABSTRACT CONCEPTS:
- For abstract concepts (e.g., well-being, mental health, school safety, physical exercise, unhealthy diet, demographics):
  - resolve through terminology.abstract_concepts
  - use only listed indicators
  - use minimal but sufficient indicator set to answer intent

FAILURE POLICY:
- Return empty only after failing:
  direct property mapping -> abstract concept mapping -> paraphrase normalization.

USER QUESTION: {{question}}
tests:
  - input:
      schema: "(:A)-[:R]->(:B)"
      terminology: ""
      examples: ""
      question: "Return 10 A to B relationships"
    expect_regex: '^MATCH \(a:A\)-\[:R\]->\(b:B\).*LIMIT 10$'

metadata:
  owner: ai-team
  created_at: 2025-10-30
