id: graph.text_to_cypher
version: 1
description: Convert a user question into a Cypher statement using the provided schema, mappings and examples.
tags: [graph, cypher, retrieval]
params:
  temperature: 0.0
  max_tokens: 1200

variables:
  - name: schema
  - name: terminology
  - name: examples
  - name: question

template: |
  Instructions: 
  Generate Cypher statement to query a graph database to get the data to answer the user question below.

  Graph Database Schema:
  Use only the provided relationship types and properties in the schema.
  Do not use any other relationship types or properties that are not provided in the schema.
  IMPORTANT: If the user's question references concepts (like "company", "organization", etc.) that do not exist in the schema, you MUST return an empty response. Do not generate a query that ignores parts of the question or answers a different question.
  {{ schema }}

  Terminology mapping:
  This section is helpful to map terminology between the user question and the graph database schema.
  {{ terminology }}

  Examples:
  The following examples provide useful patterns for querying the graph database.
  {{ examples }}

  Format instructions:
  Do not include any explanations or apologies in your responses.
  Do not respond to any questions that might ask anything else than for you to 
  construct a Cypher statement.
  Do not include any text except the generated Cypher statement.
  ONLY RESPOND WITH CYPHER, NO CODEBLOCKS.
  
  SEMANTIC CORRECTNESS REQUIREMENTS:
  - The generated query MUST answer the exact question asked by the user
  - If the question references concepts (entities, relationships, properties) that don't exist in the schema, return an empty response
  - Do NOT generate queries that ignore key parts of the question (e.g., if asked about "company" but schema has no Company node, return empty)
  - The query must semantically match the question's intent, not just be syntactically valid
  
  SECURITY RESTRICTION - READ-ONLY QUERIES ONLY:
  - You MUST ONLY generate READ-ONLY queries (SELECT/MATCH/RETURN operations)
  - NEVER generate queries with CREATE, SET, DELETE, REMOVE, MERGE, or DETACH DELETE
  - If the user asks to create, update, delete, or modify data, you MUST return an empty response
  - Only queries that READ data from the database are allowed
  - Write operations are strictly forbidden and will be rejected by the system
  
  RETURN clause guidelines:
  - Only return properties that are explicitly mentioned in the user's question
  - Include properties directly related to the query criteria (e.g., if filtering by age and smoking, return those)
  - Do NOT include unrelated properties unless the user specifically asks for them
  - Keep RETURN clauses minimal and focused on what the user requested
  
  
  Important: All Neo4j temporal properties (DateTime, LocalDateTime, Date, Time, Duration) must be converted to strings using toString() before returning them. For example: RETURN toString(tc.create_time) AS create_time

  User question: {{ question }}

tests:
  - input:
      schema: "(:A)-[:R]->(:B)"
      terminology: ""
      examples: ""
      question: "Return 10 A to B relationships"
    expect_regex: '^MATCH \(a:A\)-\[:R\]->\(b:B\).*LIMIT 10$'

metadata:
  owner: ai-team
  created_at: 2025-10-30
